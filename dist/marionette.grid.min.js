/*!
  marionette.grid 0.0.1
  git+https://github.com/jgorunova/marionette.grid.git

  Copyright (c) 2015 Julia Gorunova
  Licensed under the MIT license.
*/
!function(a,b){if("function"==typeof define&&define.amd)define(["underscore","backbone","backbone.marionette"],function(c,d,e){return a.MaGrid=b(c,d,e)});else if("object"==typeof exports){var c=require("backbone");c.$=c.$||require("jquery");var d=require("backbone.marionette");module.exports=b(require("underscore"),c,d)}else a.MaGrid=b(a._,a.Backbone,a.Marionette)}(this,function(a,b,c){"use strict";var d={},e=d.PaginatorView=b.Marionette.CollectionView.extend({tagName:"ul",childViewEventPrefix:"paginator",childView:b.Marionette.ItemView.extend({tagName:"li",template:a.template('<a href="#" title="Page <%= page_num %>"><%= label %></a>'),onRender:function(){this.$el.removeClass(this.getOption("currentPageClass")),this.$el.removeClass(this.getOption("disabledPageClass")),this.model.get("is_current")?this.$el.addClass(this.getOption("currentPageClass")):this.model.get("is_disabled")&&this.$el.addClass(this.getOption("disabledPageClass"))},modelEvents:{change:"render"},events:{"click a":"on_click"},on_click:function(a){a.preventDefault(),this.trigger("page:click")}}),childViewOptions:function(){return{currentPageClass:this.getOption("currentPageClass"),disabledPageClass:this.getOption("disabledPageClass")}},initialize:function(){this.collection=new b.Collection([],{model:b.Model.extend({defaults:{id:null,is_current:!1,is_disabled:!1,label:""}})}),this.bindedCollection=this.getOption("bindedCollection"),this.listenTo(this.bindedCollection,"add",this.recalculatePages),this.listenTo(this.bindedCollection,"remove",this.recalculatePages),this.listenTo(this.bindedCollection,"reset",this.recalculatePages),this.recalculatePages()},onRender:function(){this.$el.addClass(this.getOption("paginatorClassName"))},onBeforeDestroy:function(){this.bindedCollection&&this.stopListening(this.bindedCollection)},recalculatePages:function(){var a=this.bindedCollection,b=this.getOption("paginatorWindowSize"),c=a.state,d=Math.max(1,c.firstPage),e=Math.max(1,c.firstPage,c.lastPage),f=Math.max(c.currentPage,c.firstPage),g=Math.max(1,f-1),h=Math.min(e,f+1),i=[{is_current:!1,label:"<<",is_disabled:1==f,page_num:1},{is_current:!1,label:"<",is_disabled:1==f,page_num:g}],j=this.calculateWindow(d,f,e,b),k=[{is_current:!1,label:">",is_disabled:f==e,page_num:h},{is_current:!1,label:">>",is_disabled:f==e,page_num:e}],l=i.concat(j).concat(k);this.collection.reset(l)},calculateWindow:function(a,b,c,d){for(var e,f,g=[{is_current:!0,label:b+"",is_disabled:!1,page_num:b}],e=1;d>=e&&!(g.length>=d)&&(f=b+e,!(c>=f&&(g.push({is_current:!1,label:f+"",is_disabled:b==c,page_num:f}),g.length>=d)))&&(f=b-e,!(f>=a&&(g.splice(0,0,{is_current:!1,label:f+"",is_disabled:b==a,page_num:f}),g.length>=d)));e++);return g}}),f=d.CellView=b.Marionette.ItemView.extend({tagName:"td",template:a.template("<div><%= model[attr] %></div>"),templateHelpers:function(){return{model:this.getOption("bindedModel").toJSON()}},modelEvents:{change:"render"},triggers:{"click div":"cell:click"}}),g=d.RowView=b.Marionette.CollectionView.extend({reorderOnSort:!0,tagName:"tr",childViewEventPrefix:"row",getChildView:function(a){return a.get("cell")||f},childViewOptions:function(){return{bindedModel:this.model}}}),h=d.BodyView=b.Marionette.CollectionView.extend({reorderOnSort:!0,template:!1,childView:g,childViewEventPrefix:"body",childViewOptions:function(a,b){return{collection:this.getOption("columns")}}}),i=d.HeaderView=b.Marionette.CollectionView.extend({tagName:"tr",reorderOnSort:!0,childViewEventPrefix:"header",childViewOptions:function(){return{sortingAscClassName:this.getOption("sortingAscClassName"),sortingDescClassName:this.getOption("sortingDescClassName")}},childView:b.Marionette.ItemView.extend({tagName:"th",template:a.template("<a><%= header %></a>"),triggers:{"click a":"cell:click"},modelEvents:{"change:direction":"on_direction_changed"},initialize:function(){this.sortingAscClassName=this.getOption("sortingAscClassName"),this.sortingDescClassName=this.getOption("sortingDescClassName")},on_direction_changed:function(a,b){"asc"==b?this.$el.addClass(this.sortingAscClassName):"desc"==b?this.$el.addClass(this.sortingDescClassName):this.$el.removeClass(this.sortingDescClassName).removeClass(this.sortingAscClassName)}})});d.GridView=c.LayoutView.extend({collection:null,columns:null,options:{showLoader:!0,paginatorWindowSize:4,className:"magrid-container",tableContainerClassName:"magrid-table-container",paginatorContainerClassName:"magrid-paginator-container",overlayContainerClassName:"magrid-overlay-container",tableClassName:"magrid-table",paginatorClassName:"magrid-paginator",sortingAscClassName:"magrid-asc",sortingDescClassName:"magrid-desc",overlayBoxClassName:"magrid-overlay",currentPageClass:"magrid-active-page",disabledPageClass:"magrid-disabled-page",overlayText:"",cellEvents:{},defaultComparator:function(a,b,c,d){var e,f;return"desc"==b?(e=c.get(a),f=d.get(a)):(e=d.get(a),f=c.get(a)),e>f?-1:f>e?1:0}},template:a.template(['<div class="<%= tableContainerClassName %>">','  <table class="<%= tableClassName %>">',"    <thead></thead>","    <tbody></tbody>","    <tfoot></tfoot>","  </table>","</div>",'<div class="<%= paginatorContainerClassName %>"></div>','<div class="<%= overlayContainerClassName %>" style="display: none;">','  <div class="<%= overlayBoxClassName %>"><%= overlayText %></div>',"</div>"].join("")),templateHelpers:function(){return{tableContainerClassName:this.getOption("tableContainerClassName"),tableClassName:this.getOption("tableClassName"),paginatorContainerClassName:this.getOption("paginatorContainerClassName"),overlayContainerClassName:this.getOption("overlayContainerClassName"),overlayBoxClassName:this.getOption("overlayBoxClassName"),overlayText:this.getOption("overlayText")}},regions:function(){return{headerRegion:"thead",footerRegion:"tfoot",paginatorRegion:"."+this.getOption("paginatorContainerClassName")}},ui:function(){return{body:"tbody",overlay:"."+this.getOption("overlayContainerClassName")}},collectionEvents:{all:"on_collection_event"},childEvents:{"header:cell:click":"on_header_cell_clicked","paginator:page:click":"on_page_clicked"},initialize:function(){this.columnsCollection=new b.Collection(this.getOption("columns"),{model:b.Model.extend({defaults:{header:"",attr:"",sortable:!0,cell:null,comparator:null}})})},showLoader:function(){this.ui.overlay.show()},hideLoader:function(){this.ui.overlay.hide()},onRender:function(){var a=this.getHeaderView();a&&this.headerRegion.show(a);var b=this.getBodyView();b.render();var c=this.getFooterView();c&&this.footerRegion.show(c);var d=this.getPaginatorView();d&&this.paginatorRegion.show(d)},getHeaderView:function(){return this._headerView||(this._headerView=new i({collection:this.columnsCollection,sortingAscClassName:this.getOption("sortingAscClassName"),sortingDescClassName:this.getOption("sortingDescClassName")})),this._headerView},getBodyView:function(){return this._bodyView||(this._bodyView=new h({el:this.ui.body,collection:this.collection,columns:this.columnsCollection}),this.listenTo(this._bodyView,"all",this.on_cell_event)),this._bodyView},getFooterView:function(){},getPaginatorView:function(){return this._paginatorView||b.PageableCollection&&this.collection instanceof b.PageableCollection&&(this._paginatorView=new e({bindedCollection:this.collection,paginatorClassName:this.getOption("paginatorClassName"),currentPageClass:this.getOption("currentPageClass"),disabledPageClass:this.getOption("disabledPageClass"),paginatorWindowSize:this.getOption("paginatorWindowSize")})),this._paginatorView},onBeforeDestroy:function(){this._bodyView&&(this.stopListening(this._bodyView),this._bodyView.destroy())},on_collection_event:function(a){"request"==a&&this.getOption("showLoader")?this.showLoader():("sync"==a||"error"==a)&&this.hideLoader()},on_header_cell_clicked:function(c,d){var e=d.model,f=e.get("attr"),g="asc"==e.get("direction")?"desc":"asc",h="asc"==g?-1:1;this.columnsCollection.forEach(function(a,b){a.set("direction",null)}),e.set("direction",g);var i=e.get("comparator");a.isFunction(i)?i=a.partial(i,g):(i=this.getOption("defaultComparator"),i=a.partial(i,f,g)),this.collection instanceof b.PageableCollection?(this.collection.setSorting(f,h),this.collection.fullCollection?(this.collection.fullCollection.comparator=i,this.collection.fullCollection.sort()):(this.collection.state.currentPage=1,this.collection.fetch({reset:!0,success:function(){}}))):(this.collection.comparator=i,this.collection.sort())},on_page_clicked:function(a,b){if(!b.model.get("is_active")&&!b.model.get("is_disabled")){var c=b.model.get("page_num");this.collection.getPage(c)}},on_cell_event:function(b,c,d,e){var f=b.replace("body:row:",""),g=(this.getOption("cellEvents")||{})[f];a.isFunction(g)?g(d,e):a.isFunction(this[g])&&this[g](d,e)}});return d});